<div class="p-4">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold">Maps Tracking</h1>
    <div class="flex items-center gap-4">
      @if (playerName) {
        <div class="text-gray-400">
          Viewing maps for: <span class="text-primary font-bold">{{ playerName }}</span>
        </div>
      }
      <p-select
        [options]="sessions"
        [(ngModel)]="selectedSession"
        (onChange)="onSessionChange(dt)"
        optionLabel="label"
        placeholder="Filter by Session"
        [showClear]="true"
        appendTo="body"
        [style]="{'min-width': '250px', 'margin-left': '1rem'}"
      ></p-select>
    </div>
  </div>

  <p-table
    #dt
    [value]="maps"
    [lazy]="true"
    (onLazyLoad)="loadMaps($event)"
    [paginator]="true"
    [rows]="20"
    [totalRecords]="totalRecords"
    [loading]="loading"
    [showCurrentPageReport]="true"
    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
    styleClass="p-datatable-sm p-datatable-striped"
    [rowsPerPageOptions]="[10, 20, 50, 100]"
    dataKey="id"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="map_name">
          Map Name <p-sortIcon field="map_name"></p-sortIcon>
        </th>
        <th pSortableColumn="map_difficulty">
          Difficulty <p-sortIcon field="map_difficulty"></p-sortIcon>
        </th>
        <th pSortableColumn="duration">
          Duration <p-sortIcon field="duration"></p-sortIcon>
        </th>
        <th pSortableColumn="currency_gained">
          Currency <p-sortIcon field="currency_gained"></p-sortIcon>
        </th>
        <th pSortableColumn="exp_gained">
          EXP <p-sortIcon field="exp_gained"></p-sortIcon>
        </th>
        <th pSortableColumn="items_gained">
          Items <p-sortIcon field="items_gained"></p-sortIcon>
        </th>
        <th pSortableColumn="completed_at">
          Completed At <p-sortIcon field="completed_at"></p-sortIcon>
        </th>
        <th style="width: 100px; text-align: center">Actions</th>
      </tr>
      <tr>
        <th>
          <input pInputText type="text" [(ngModel)]="filterMapName" (input)="onFilterChange(dt)" placeholder="Search by name" class="w-full" />
        </th>
        <th>
          <p-multiSelect
            [options]="difficultyOptions"
            [(ngModel)]="filterDifficulties"
            (onChange)="onFilterChange(dt)"
            placeholder="All Difficulties"
            optionLabel="label"
            optionValue="value"
            [style]="{'width': '100%'}"
            appendTo="body"
          >
          </p-multiSelect>
        </th>
        <th></th>
        <th>
          <input pInputText type="number" [(ngModel)]="filterMinCurrency" (input)="onFilterChange(dt)" placeholder="Min currency" class="w-full" />
        </th>
        <th>
          <input pInputText type="number" [(ngModel)]="filterMinExp" (input)="onFilterChange(dt)" placeholder="Min EXP" class="w-full" />
        </th>
        <th>
          <input pInputText type="number" [(ngModel)]="filterMinItems" (input)="onFilterChange(dt)" placeholder="Min items" class="w-full" />
        </th>
        <th></th>
        <th style="width: 100px"></th>
      </tr>
    </ng-template>
    <ng-template pTemplate="body" let-map>
      <tr>
        <td>
          <span class="font-semibold">{{ map.map_name || 'Map #' + map.map_id }}</span>
        </td>
        <td>
          @if (map.map_difficulty) {
            <span class="inline-block px-3 py-1 rounded-full text-sm font-medium"
                  [ngClass]="{
                    'bg-green-900/40 text-green-300 border border-green-700/50': map.map_difficulty.includes('T8'),
                    'bg-blue-900/40 text-blue-300 border border-blue-700/50': map.map_difficulty.includes('T16'),
                    'bg-purple-900/40 text-purple-300 border border-purple-700/50': map.map_difficulty.includes('T17'),
                    'bg-red-900/40 text-red-300 border border-red-700/50': map.map_difficulty.includes('Uber'),
                    'bg-gray-900/40 text-gray-300 border border-gray-700/50': !map.map_difficulty.includes('T8') && !map.map_difficulty.includes('T16') && !map.map_difficulty.includes('T17') && !map.map_difficulty.includes('Uber')
                  }">
              {{ map.map_difficulty | difficulty }}
            </span>
          } @else {
            <span class="text-gray-500">-</span>
          }
        </td>
        <td>
          <span class="text-gray-200">{{ formatDuration(map.duration) }}</span>
        </td>
        <td>
          <span class="font-semibold text-yellow-400">{{ formatNumber(map.currency_gained, 2) }}</span>
        </td>
        <td>
          <span class="font-semibold text-blue-400">{{ formatNumber(map.exp_gained, 0) }}</span>
        </td>
        <td>
          <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-gray-700/50 text-gray-200 font-medium">{{ map.items_gained }}</span>
        </td>
        <td class="text-sm text-gray-400">{{ formatDate(map.completed_at) }}</td>
        <td class="text-center">
          <div class="inline-flex gap-1">
            <button 
              (click)="showMapDetails(map)"
              title="View Details"
              class="w-8 h-8 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition text-lg leading-none"
            >
              üîç
            </button>
            <button 
              (click)="confirmDeleteMap(map)"
              title="Delete"
              class="w-8 h-8 rounded-full bg-red-600 hover:bg-red-700 text-white flex items-center justify-center transition text-lg leading-none"
            >
              üóëÔ∏è
            </button>
          </div>
        </td>
      </tr>
    </ng-template>
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="8" class="text-center text-gray-400 py-8">
          No map completions found
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>

<!-- Reusable Map Detail Component -->
<app-map-detail 
  [(visible)]="showDetailDialog"
  [mapId]="selectedMapId"
  (onDelete)="onMapDeleted($event)"
></app-map-detail>